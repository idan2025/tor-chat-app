// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    ext {
        buildToolsVersion = "34.0.0"
        minSdkVersion = 24
        compileSdkVersion = 34
        targetSdkVersion = 34
        ndkVersion = "25.1.8937393"

        // Dependency versions
        kotlinVersion = "1.9.22"
        googleServicesVersion = "4.4.0"

        // React Native compatibility
        supportLibVersion = "28.0.0"
    }

    repositories {
        google()
        mavenCentral()
        maven { url 'https://jitpack.io' }
    }

    dependencies {
        classpath("com.android.tools.build:gradle:8.1.1")
        classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
        maven {
            // All of React Native (JS, Obj-C sources, Android binaries) is installed from npm
            // Use canonical path to resolve symlinks properly
            def nodeModulesPath = file("$rootDir/../node_modules").exists() ?
                file("$rootDir/../node_modules").canonicalPath :
                file("$rootDir/../../node_modules").canonicalPath
            url("file://${nodeModulesPath}/react-native/android")
        }
        maven {
            // Android JSC is installed from npm
            def nodeModulesPath = file("$rootDir/../node_modules").exists() ?
                file("$rootDir/../node_modules").canonicalPath :
                file("$rootDir/../../node_modules").canonicalPath
            url("file://${nodeModulesPath}/jsc-android/dist")
        }
        maven {
            // Guardian Project repo for Tor libraries
            url "https://raw.githubusercontent.com/guardianproject/gpmaven/master"
        }
        maven { url 'https://jitpack.io' }
    }
}

// Enable BuildConfig for all React Native library modules
// AGP 8.x compatibility: buildConfig is enabled globally via gradle.properties
// This ensures all modules work correctly with AGP 8.x
subprojects { subproject ->
    afterEvaluate {
        if (subproject.plugins.hasPlugin('com.android.library')) {
            // Ensure buildConfig is enabled
            subproject.android {
                buildFeatures {
                    buildConfig = true
                }

                // AGP 8.x requires namespace to be set
                // Auto-inject namespace for libraries that don't have it
                if (subproject.android.namespace == null) {
                    def manifestFile = subproject.file('src/main/AndroidManifest.xml')

                    if (manifestFile.exists()) {
                        def manifestText = manifestFile.text
                        def packageMatch = manifestText =~ /package="([^"]+)"/

                        if (packageMatch) {
                            // If manifest has package attribute, use it as namespace
                            def packageName = packageMatch[0][1]
                            subproject.android.namespace = packageName
                            logger.info("AGP 8.x: Set namespace from manifest for ${subproject.name}: ${packageName}")
                        }
                    }

                    // If still no namespace (no manifest or no package in manifest)
                    // Generate a namespace from the module name
                    if (subproject.android.namespace == null) {
                        def generatedNamespace = "com.${subproject.name.replaceAll(/[^a-zA-Z0-9]/, '').toLowerCase()}"
                        subproject.android.namespace = generatedNamespace
                        logger.warn("AGP 8.x: Generated namespace for ${subproject.name}: ${generatedNamespace}")
                    }
                }
            }
        }
    }
}

tasks.register('clean', Delete) {
    delete rootProject.buildDir
}

// Task to debug namespace configuration for all library modules
// This checks namespace setup after all projects are evaluated
tasks.register('checkNamespaces') {
    group = 'verification'
    description = 'Checks namespace configuration for all Android library modules'

    doLast {
        println "=========================================="
        println "AGP 8.x Namespace Configuration Report"
        println "=========================================="
        println ""

        def libraryCount = 0
        def namespaceCount = 0
        def issues = []

        rootProject.subprojects { subproject ->
            subproject.plugins.withId('com.android.library') {
                libraryCount++

                def namespace = subproject.android.namespace
                def manifestFile = subproject.file('src/main/AndroidManifest.xml')
                def packageInManifest = null

                if (manifestFile.exists()) {
                    def manifestText = manifestFile.text
                    def packageMatch = manifestText =~ /package="([^"]+)"/
                    if (packageMatch) {
                        packageInManifest = packageMatch[0][1]
                    }
                }

                if (namespace != null) {
                    namespaceCount++
                    println "${subproject.name}"
                    println "  Namespace: ${namespace}"
                    if (packageInManifest) {
                        if (namespace == packageInManifest) {
                            println "  Manifest:  ${packageInManifest} (matches namespace)"
                        } else {
                            println "  Manifest:  ${packageInManifest} (MISMATCH!)"
                            issues << "${subproject.name}: namespace != package (${namespace} vs ${packageInManifest})"
                        }
                    } else {
                        println "  Manifest:  (no package attribute)"
                    }
                    println ""
                } else {
                    issues << "${subproject.name}: NO NAMESPACE SET!"
                    println "${subproject.name}"
                    println "  WARNING: No namespace configured!"
                    if (packageInManifest) {
                        println "  Manifest:  ${packageInManifest} (could be used as namespace)"
                    }
                    println ""
                }
            }
        }

        println "=========================================="
        println "Summary"
        println "=========================================="
        println "Total library modules: ${libraryCount}"
        println "Modules with namespace: ${namespaceCount}"

        if (issues.isEmpty()) {
            println ""
            println "SUCCESS: All library modules have namespace configured!"
            println "Your project is AGP 8.x compliant."
        } else {
            println ""
            println "Issues found (${issues.size()}):"
            issues.each { issue ->
                println "  - ${issue}"
            }
            println ""
            println "These issues may cause build failures with AGP 8.x"
        }
        println "=========================================="
    }
}

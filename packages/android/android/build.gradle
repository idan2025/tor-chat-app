// Top-level build file where you can add configuration options common to all sub-projects/modules.

// Apply React Native 0.73+ Maven repository fix
// This removes outdated node_modules/react-native/android references from all subprojects
apply from: file("react-native-maven-fix.gradle")

buildscript {
    ext {
        buildToolsVersion = "34.0.0"
        minSdkVersion = 24
        compileSdkVersion = 34
        targetSdkVersion = 34
        ndkVersion = "25.1.8937393"

        // Dependency versions
        kotlinVersion = "1.9.22"
        googleServicesVersion = "4.4.0"

        // React Native compatibility
        supportLibVersion = "28.0.0"
    }

    repositories {
        google()
        mavenCentral()
        maven { url 'https://jitpack.io' }
    }

    dependencies {
        classpath("com.android.tools.build:gradle:8.1.1")
        classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
        // React Native 0.71+ distributes Android artifacts via Maven Central
        // No need to point to node_modules/react-native/android anymore
        maven {
            // Guardian Project repo for Tor libraries
            url "https://raw.githubusercontent.com/guardianproject/gpmaven/master"
        }
        maven { url 'https://jitpack.io' }
    }

    // React Native 0.73+ dependency resolution fix
    // RN 0.73+ changed from 'com.facebook.react:react-native' to 'com.facebook.react:react-android'
    // Community packages still reference the old artifact name, so we redirect it
    configurations.all {
        resolutionStrategy {
            // Substitute old artifact name with new one
            dependencySubstitution {
                substitute(module('com.facebook.react:react-native'))
                    .using(module('com.facebook.react:react-android:0.73.0'))
                    .because('React Native 0.73+ uses react-android artifact on Maven Central')
            }

            // Force consistent versions for React Native dependencies
            force 'com.facebook.react:react-android:0.73.0'
            force 'com.facebook.react:hermes-android:0.73.0'
        }
    }
}

// Enable BuildConfig for all React Native library modules
// AGP 8.x compatibility: buildConfig is enabled globally via gradle.properties
// This ensures all modules work correctly with AGP 8.x
subprojects { subproject ->
    afterEvaluate {
        if (subproject.plugins.hasPlugin('com.android.library') || subproject.plugins.hasPlugin('com.android.application')) {
            // Ensure buildConfig is enabled
            subproject.android {
                // Force consistent SDK versions across all modules
                // This prevents issues where old packages use lower compileSdkVersion
                compileSdkVersion rootProject.ext.compileSdkVersion

                buildFeatures {
                    buildConfig = true
                }

                // Force Java 17 for all modules (required by React Native 0.73+)
                // React Native 0.73 upgraded to AGP 8.x which requires Java 17
                compileOptions {
                    sourceCompatibility JavaVersion.VERSION_17
                    targetCompatibility JavaVersion.VERSION_17
                }

                // AGP 8.x requires namespace to be set
                // Auto-inject namespace for libraries that don't have it
                if (subproject.android.namespace == null) {
                    def manifestFile = subproject.file('src/main/AndroidManifest.xml')

                    if (manifestFile.exists()) {
                        def manifestText = manifestFile.text
                        def packageMatch = manifestText =~ /package="([^"]+)"/

                        if (packageMatch) {
                            // If manifest has package attribute, use it as namespace
                            def packageName = packageMatch[0][1]
                            subproject.android.namespace = packageName
                            logger.info("AGP 8.x: Set namespace from manifest for ${subproject.name}: ${packageName}")
                        }
                    }

                    // If still no namespace (no manifest or no package in manifest)
                    // Generate a namespace from the module name
                    if (subproject.android.namespace == null) {
                        def generatedNamespace = "com.${subproject.name.replaceAll(/[^a-zA-Z0-9]/, '').toLowerCase()}"
                        subproject.android.namespace = generatedNamespace
                        logger.warn("AGP 8.x: Generated namespace for ${subproject.name}: ${generatedNamespace}")
                    }
                }
            }

            // Force Kotlin JVM target 17 for all Kotlin modules
            if (subproject.plugins.hasPlugin('org.jetbrains.kotlin.android')) {
                subproject.tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
                    kotlinOptions {
                        jvmTarget = '17'
                    }
                }
            }
        }
    }
}

tasks.register('clean', Delete) {
    delete rootProject.buildDir
}

// Task to debug namespace configuration for all library modules
// This checks namespace setup after all projects are evaluated
tasks.register('checkNamespaces') {
    group = 'verification'
    description = 'Checks namespace configuration for all Android library modules'

    doLast {
        println "=========================================="
        println "AGP 8.x Namespace Configuration Report"
        println "=========================================="
        println ""

        def libraryCount = 0
        def namespaceCount = 0
        def issues = []

        rootProject.subprojects { subproject ->
            subproject.plugins.withId('com.android.library') {
                libraryCount++

                def namespace = subproject.android.namespace
                def manifestFile = subproject.file('src/main/AndroidManifest.xml')
                def packageInManifest = null

                if (manifestFile.exists()) {
                    def manifestText = manifestFile.text
                    def packageMatch = manifestText =~ /package="([^"]+)"/
                    if (packageMatch) {
                        packageInManifest = packageMatch[0][1]
                    }
                }

                if (namespace != null) {
                    namespaceCount++
                    println "${subproject.name}"
                    println "  Namespace: ${namespace}"
                    if (packageInManifest) {
                        if (namespace == packageInManifest) {
                            println "  Manifest:  ${packageInManifest} (matches namespace)"
                        } else {
                            println "  Manifest:  ${packageInManifest} (MISMATCH!)"
                            issues << "${subproject.name}: namespace != package (${namespace} vs ${packageInManifest})"
                        }
                    } else {
                        println "  Manifest:  (no package attribute)"
                    }
                    println ""
                } else {
                    issues << "${subproject.name}: NO NAMESPACE SET!"
                    println "${subproject.name}"
                    println "  WARNING: No namespace configured!"
                    if (packageInManifest) {
                        println "  Manifest:  ${packageInManifest} (could be used as namespace)"
                    }
                    println ""
                }
            }
        }

        println "=========================================="
        println "Summary"
        println "=========================================="
        println "Total library modules: ${libraryCount}"
        println "Modules with namespace: ${namespaceCount}"

        if (issues.isEmpty()) {
            println ""
            println "SUCCESS: All library modules have namespace configured!"
            println "Your project is AGP 8.x compliant."
        } else {
            println ""
            println "Issues found (${issues.size()}):"
            issues.each { issue ->
                println "  - ${issue}"
            }
            println ""
            println "These issues may cause build failures with AGP 8.x"
        }
        println "=========================================="
    }
}

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.2.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Backend Build
  # ============================================
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./rust-backend
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust-backend/target
          key: ${{ runner.os }}-cargo-backend-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Install libsodium
        run: sudo apt-get update && sudo apt-get install -y libsodium-dev

      - name: Build release
        run: cargo build --release

      - name: Upload backend binary
        uses: actions/upload-artifact@v4
        with:
          name: tor-chat-backend-linux
          path: rust-backend/target/release/tor-chat-backend

  # ============================================
  # Backend Docker
  # ============================================
  docker-backend:
    name: Build Backend Docker
    runs-on: ubuntu-latest
    needs: [build-backend]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./rust-backend
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USER }}/tor-chat-backend:latest
            ${{ secrets.DOCKERHUB_USER }}/tor-chat-backend:${{ inputs.version }}

  # ============================================
  # Web Build
  # ============================================
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./dioxus-web
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install trunk
        uses: jetli/trunk-action@v0.5.1
        with:
          version: 'latest'

      - name: Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            dioxus-web/target
          key: ${{ runner.os }}-cargo-web-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build with trunk
        run: trunk build --release

      - name: Create tarball
        run: tar -czvf ../dioxus-web-dist.tar.gz -C dist .

      - name: Upload web build
        uses: actions/upload-artifact@v4
        with:
          name: tor-chat-web
          path: dioxus-web-dist.tar.gz

  # ============================================
  # Web Docker
  # ============================================
  docker-web:
    name: Build Web Docker
    runs-on: ubuntu-latest
    needs: [build-web]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push web
        uses: docker/build-push-action@v5
        with:
          context: ./dioxus-web
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USER }}/tor-chat-web:latest
            ${{ secrets.DOCKERHUB_USER }}/tor-chat-web:${{ inputs.version }}

  # ============================================
  # Tor Docker
  # ============================================
  docker-tor:
    name: Build Tor Docker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push tor
        uses: docker/build-push-action@v5
        with:
          context: ./tor
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USER }}/tor-chat-tor:latest
            ${{ secrets.DOCKERHUB_USER }}/tor-chat-tor:${{ inputs.version }}

  # ============================================
  # Desktop Linux Build
  # ============================================
  build-desktop-linux:
    name: Build Desktop (Linux)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./dioxus-desktop
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev \
            build-essential curl wget libssl-dev libgtk-3-dev \
            libayatana-appindicator3-dev librsvg2-dev libxdo-dev

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            dioxus-desktop/target
          key: ${{ runner.os }}-cargo-desktop-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: cargo build --release

      - name: Create AppImage
        run: |
          wget -O linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/scalable/apps
          cp target/release/tor-chat-desktop AppDir/usr/bin/
          cp tor-chat-desktop.desktop AppDir/usr/share/applications/ || true
          cp tor-chat-desktop.svg AppDir/usr/share/icons/hicolor/scalable/apps/ || true
          ./linuxdeploy --appdir AppDir --output appimage || true

      - name: Upload Linux desktop
        uses: actions/upload-artifact@v4
        with:
          name: tor-chat-desktop-linux
          path: |
            dioxus-desktop/target/release/tor-chat-desktop
            dioxus-desktop/*.AppImage

  # ============================================
  # Desktop Windows Build
  # ============================================
  build-desktop-windows:
    name: Build Desktop (Windows)
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ./dioxus-desktop
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            dioxus-desktop/target
          key: ${{ runner.os }}-cargo-desktop-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: cargo build --release

      - name: Upload Windows desktop
        uses: actions/upload-artifact@v4
        with:
          name: tor-chat-desktop-windows
          path: dioxus-desktop/target/release/tor-chat-desktop.exe

  # ============================================
  # Desktop macOS Build
  # ============================================
  build-desktop-macos:
    name: Build Desktop (macOS)
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ./dioxus-desktop
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            dioxus-desktop/target
          key: ${{ runner.os }}-cargo-desktop-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: cargo build --release

      - name: Create macOS bundle
        run: |
          mkdir -p TorChat.app/Contents/MacOS TorChat.app/Contents/Resources
          cp target/release/tor-chat-desktop TorChat.app/Contents/MacOS/
          cat > TorChat.app/Contents/Info.plist <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key><string>TOR Chat</string>
            <key>CFBundleDisplayName</key><string>TOR Chat</string>
            <key>CFBundleIdentifier</key><string>com.torchat.desktop</string>
            <key>CFBundleVersion</key><string>${{ inputs.version }}</string>
            <key>CFBundlePackageType</key><string>APPL</string>
            <key>CFBundleExecutable</key><string>tor-chat-desktop</string>
          </dict>
          </plist>
          PLIST

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg --volname "TOR Chat" --app-drop-link 600 185 "TorChat-${{ inputs.version }}.dmg" "TorChat.app" || true

      - name: Upload macOS desktop
        uses: actions/upload-artifact@v4
        with:
          name: tor-chat-desktop-macos
          path: |
            dioxus-desktop/TorChat.app
            dioxus-desktop/*.dmg

  # ============================================
  # Android Build
  # ============================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./flutter-app
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            flutter-app/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('flutter-app/pubspec.yaml') }}

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Build App Bundle
        run: flutter build appbundle --release

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: tor-chat-android-apk
          path: flutter-app/build/app/outputs/flutter-apk/app-release.apk

      - name: Upload Android Bundle
        uses: actions/upload-artifact@v4
        with:
          name: tor-chat-android-bundle
          path: flutter-app/build/app/outputs/bundle/release/app-release.aab

  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-backend, build-web, build-desktop-linux, build-desktop-windows, build-desktop-macos, build-android, docker-backend, docker-web, docker-tor]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          # Backend
          cp artifacts/tor-chat-backend-linux/tor-chat-backend release-assets/tor-chat-backend-linux-amd64
          # Web
          cp artifacts/tor-chat-web/dioxus-web-dist.tar.gz release-assets/tor-chat-web-${{ inputs.version }}.tar.gz
          # Desktop Linux
          cp artifacts/tor-chat-desktop-linux/tor-chat-desktop release-assets/tor-chat-desktop-linux-amd64 || true
          cp artifacts/tor-chat-desktop-linux/*.AppImage release-assets/ || true
          # Desktop Windows
          cp artifacts/tor-chat-desktop-windows/tor-chat-desktop.exe release-assets/tor-chat-desktop-windows-amd64.exe || true
          # Desktop macOS
          cp artifacts/tor-chat-desktop-macos/*.dmg release-assets/ || true
          # Android
          cp artifacts/tor-chat-android-apk/app-release.apk release-assets/tor-chat-android-${{ inputs.version }}.apk
          cp artifacts/tor-chat-android-bundle/app-release.aab release-assets/tor-chat-android-${{ inputs.version }}.aab || true
          ls -la release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: TOR Chat ${{ inputs.version }}
          body: |
            ## TOR Chat ${{ inputs.version }}
            
            ### Downloads
            - **Android**: `tor-chat-android-${{ inputs.version }}.apk`
            - **Windows**: `tor-chat-desktop-windows-amd64.exe`
            - **macOS**: `TorChat-${{ inputs.version }}.dmg`
            - **Linux**: `tor-chat-desktop-linux-amd64` or AppImage
            - **Web**: `tor-chat-web-${{ inputs.version }}.tar.gz`
            - **Backend**: `tor-chat-backend-linux-amd64`
            
            ### Docker Images
            - `${{ secrets.DOCKERHUB_USER }}/tor-chat-backend:${{ inputs.version }}`
            - `${{ secrets.DOCKERHUB_USER }}/tor-chat-web:${{ inputs.version }}`
            - `${{ secrets.DOCKERHUB_USER }}/tor-chat-tor:${{ inputs.version }}`
          files: release-assets/*
          draft: false
          prerelease: ${{ inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Android KMP Build & Test

# Trigger on pushes to main, PRs affecting Android code, and manual dispatch
on:
  push:
    branches:
      - main
    paths:
      - 'packages/android/**'
      - '.github/workflows/android-kmp-build.yml'
  pull_request:
    paths:
      - 'packages/android/**'
      - '.github/workflows/android-kmp-build.yml'
  workflow_dispatch:

# Ensure only one build runs per PR/branch at a time
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Test Android KMP
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      pull-requests: write  # For PR comments

    steps:
      # =====================================================
      # CHECKOUT & SETUP
      # =====================================================

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better caching

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platform-tools
            platforms;android-35
            build-tools;35.0.0

      # =====================================================
      # GRADLE CACHING - Optimized for faster builds
      # =====================================================

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          gradle-home-cache-cleanup: true

      - name: Cache Kotlin/Native compiler
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('packages/android/**/*.gradle.kts') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      # =====================================================
      # GRADLE BUILD - Debug APK
      # =====================================================

      - name: Make gradlew executable
        working-directory: packages/android
        run: chmod +x gradlew

      - name: Build Debug APK
        working-directory: packages/android
        run: ./gradlew assembleDebug --stacktrace --scan
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError"

      # =====================================================
      # TESTING - Run unit tests if they exist
      # =====================================================

      - name: Run Unit Tests
        working-directory: packages/android
        run: ./gradlew test --continue --stacktrace
        continue-on-error: true  # Don't fail if no tests exist yet
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m"

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            packages/android/**/build/reports/tests/
            packages/android/**/build/test-results/
          retention-days: 7
          if-no-files-found: ignore

      # =====================================================
      # APK ANALYSIS & ARTIFACTS
      # =====================================================

      - name: Analyze APK size
        id: apk_analysis
        working-directory: packages/android
        run: |
          APK_PATH=$(find androidApp/build/outputs/apk/debug -name "*.apk" | head -n 1)

          if [ -z "$APK_PATH" ]; then
            echo "Error: No APK found!"
            exit 1
          fi

          # Get APK size in bytes and human-readable format
          APK_SIZE_BYTES=$(stat -c%s "$APK_PATH")
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE_BYTES / 1048576" | bc)
          APK_NAME=$(basename "$APK_PATH")

          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_size_bytes=$APK_SIZE_BYTES" >> $GITHUB_OUTPUT
          echo "apk_size_mb=${APK_SIZE_MB} MB" >> $GITHUB_OUTPUT

          echo "APK: $APK_NAME"
          echo "Size: $APK_SIZE_MB MB ($APK_SIZE_BYTES bytes)"

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: ${{ steps.apk_analysis.outputs.apk_path }}
          retention-days: 30
          compression-level: 0  # APKs are already compressed

      # =====================================================
      # PR COMMENT - Report build results
      # =====================================================

      - name: Comment on PR with APK details
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const apkName = '${{ steps.apk_analysis.outputs.apk_name }}';
            const apkSize = '${{ steps.apk_analysis.outputs.apk_size_mb }}';
            const runId = context.runId;
            const sha = context.sha.substring(0, 7);

            const comment = `## ðŸ“± Android Build Complete

            | Property | Value |
            |----------|-------|
            | **APK Name** | \`${apkName}\` |
            | **Size** | **${apkSize}** |
            | **Commit** | \`${sha}\` |
            | **Workflow Run** | [#${runId}](https://github.com/${{ github.repository }}/actions/runs/${runId}) |

            The debug APK is available as a workflow artifact for 30 days.

            <details>
            <summary>ðŸ“¥ Download Instructions</summary>

            1. Go to the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${runId})
            2. Scroll to the **Artifacts** section at the bottom
            3. Download \`android-debug-apk\`
            4. Extract and install on your device
            </details>
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      # =====================================================
      # BUILD SUMMARY
      # =====================================================

      - name: Generate build summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Build Summary

          ### APK Details
          - **Name:** ${{ steps.apk_analysis.outputs.apk_name }}
          - **Size:** ${{ steps.apk_analysis.outputs.apk_size_mb }}
          - **Build Type:** Debug
          - **Modules:** shared, androidApp

          ### Build Configuration
          - **JDK Version:** 17 (Temurin)
          - **Gradle Version:** 8.11.1
          - **Android Gradle Plugin:** 8.7.3
          - **Kotlin Version:** 2.1.0
          - **Target SDK:** 35
          - **Min SDK:** 24

          ### Performance
          - **Workflow Duration:** ${{ job.status }}
          - **Cache Status:** Gradle cache enabled

          EOF

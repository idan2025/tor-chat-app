name: Dioxus Desktop CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'dioxus-desktop/**'
      - 'dioxus-web/**'
      - '.github/workflows/dioxus-desktop.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'dioxus-desktop/**'
      - 'dioxus-web/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./dioxus-desktop
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo-dev

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            dioxus-desktop/target
          key: ${{ runner.os }}-cargo-desktop-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-desktop-

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy -- -D warnings -A dead_code

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: [lint]
    defaults:
      run:
        working-directory: ./dioxus-desktop
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo-dev

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            dioxus-desktop/target
          key: ${{ runner.os }}-cargo-desktop-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-desktop-build-
            ${{ runner.os }}-cargo-desktop-

      - name: Build
        run: cargo build --release

      - name: Create AppImage
        run: |
          wget -O linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy
          mkdir -p AppDir/usr/bin
          cp target/release/tor-chat-desktop AppDir/usr/bin/
          ./linuxdeploy --appdir AppDir --output appimage

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: tor-chat-desktop-linux
          path: |
            dioxus-desktop/target/release/tor-chat-desktop
            dioxus-desktop/*.AppImage
          retention-days: 7

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: [lint]
    defaults:
      run:
        working-directory: ./dioxus-desktop
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            dioxus-desktop/target
          key: ${{ runner.os }}-cargo-desktop-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-desktop-build-
            ${{ runner.os }}-cargo-desktop-

      - name: Build
        run: cargo build --release

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: tor-chat-desktop-windows
          path: dioxus-desktop/target/release/tor-chat-desktop.exe
          retention-days: 7

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: [lint]
    defaults:
      run:
        working-directory: ./dioxus-desktop
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            dioxus-desktop/target
          key: ${{ runner.os }}-cargo-desktop-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-desktop-build-
            ${{ runner.os }}-cargo-desktop-

      - name: Build
        run: cargo build --release

      - name: Create macOS bundle
        run: |
          mkdir -p TorChat.app/Contents/MacOS
          mkdir -p TorChat.app/Contents/Resources
          cp target/release/tor-chat-desktop TorChat.app/Contents/MacOS/
          cat > TorChat.app/Contents/Info.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key>
            <string>TOR Chat</string>
            <key>CFBundleDisplayName</key>
            <string>TOR Chat</string>
            <key>CFBundleIdentifier</key>
            <string>com.torchat.desktop</string>
            <key>CFBundleVersion</key>
            <string>0.2.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleExecutable</key>
            <string>tor-chat-desktop</string>
          </dict>
          </plist>
          EOF

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "TOR Chat" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "TorChat.dmg" \
            "TorChat.app"

      - name: Upload macOS binary
        uses: actions/upload-artifact@v4
        with:
          name: tor-chat-desktop-macos
          path: |
            dioxus-desktop/TorChat.app
            dioxus-desktop/TorChat.dmg
          retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            tor-chat-desktop-linux/*
            tor-chat-desktop-windows/*
            tor-chat-desktop-macos/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
